<!DOCTYPE html>
<html lang="en" class="bg-black text-white overflow-x-hidden">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>John's Hangout | E2E SECURE</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700;900&family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <style>
    :root { --red: #ff0033; --darkred: #cc0022; --black: #0a0a0a; --gray: #1a1a1a; }
    body { font-family: 'Roboto Mono', monospace; background: linear-gradient(135deg, #0a0a0a 0%, #1a0000 100%); min-height: 100vh; }
    .orbitron { font-family: 'Orbitron', sans-serif; }
    .glow-red { text-shadow: 0 0 15px var(--red); animation: pulse 2s infinite; }
    .tab-active { border-bottom: 4px solid var(--red); color: var(--red); }
    .btn-red { @apply bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-5 rounded transition transform hover:scale-105; }
    .card { @apply bg-gray-900 border border-red-900 rounded-xl p-6 hover:border-red-600 transition; backdrop-filter: blur(10px); }
    .dm-active { background: #330011; border-left: 4px solid var(--red); }
    .scanline { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9999; 
      background: repeating-linear-gradient(0deg, rgba(255,0,51,0.03), rgba(255,0,51,0.03) 2px, transparent 2px, transparent 4px);
      animation: scan 8s linear infinite; }
    @keyframes pulse { 0%,100% { text-shadow: 0 0 15px var(--red); } 50% { text-shadow: 0 0 25px var(--red); } }
    @keyframes scan { from { transform: translateY(-100%); } to { transform: translateY(100%); } }
    .matrix-rain { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; opacity: 0.05; pointer-events: none; }
  </style>
</head>
<body class="relative">

<!-- MATRIX + SCANLINE -->
<canvas class="matrix-rain" id="matrix"></canvas>
<div class="scanline"></div>

<!-- NAVBAR -->
<nav class="fixed top-0 w-full bg-black bg-opacity-90 border-b border-red-900 z-50 backdrop-blur-lg">
  <div class="container mx-auto px-6 py-4 flex justify-between items-center">
    <div class="flex items-center gap-3">
      <i class="fas fa-crown text-yellow-500 text-2xl glow-red"></i>
      <h1 class="text-3xl orbitron glow-red">John's Hangout</h1>
    </div>
    <div id="auth-section"></div>
  </div>
</nav>

<!-- HERO -->
<div id="home" class="tab-content min-h-screen flex items-center justify-center pt-20">
  <div class="text-center max-w-5xl px-6">
    <h1 class="text-7xl orbitron glow-red mb-4">JOHN'S HANGOUT</h1>
    <p class="text-3xl text-red-400 mb-6">E2E ENCRYPTED • GROUPS • DMs</p>
    <button onclick="openTab('messages')" class="btn-red text-xl px-10 py-4 orbitron">ENTER SECURE ZONE</button>
  </div>
</div>

<!-- TABS -->
<div class="pt-24 pb-20">
  <div class="container mx-auto px-6 hidden md:block">
    <div class="flex gap-10 border-b border-red-900 text-lg font-bold pb-2">
      <button onclick="openTab('home')" id="tab-home" class="text-gray-500">HOME</button>
      <button onclick="openTab('videos')" id="tab-videos" class="text-gray-500">VIDEOS</button>
      <button onclick="openTab('scripts')" id="tab-scripts" class="text-gray-500">SCRIPTS</button>
      <button onclick="openTab('messages')" id="tab-messages" class="text-gray-500">MESSAGES</button>
    </div>
  </div>

  <div class="container mx-auto px-6 max-w-7xl">

    <!-- MESSAGES TAB -->
    <div id="messages" class="tab-content hidden">
      <div class="flex gap-6">
        <!-- SIDEBAR -->
        <div class="w-64 card p-0 overflow-hidden">
          <div class="p-4 border-b border-red-900 orbitron text-lg flex justify-between">
            <span>CHATS</span>
            <button onclick="showFindPlayer()" class="text-xs text-cyan-400"><i class="fas fa-search"></i></button>
          </div>
          <div id="chat-list" class="overflow-y-auto h-96"></div>
          <div class="p-3 border-t border-red-900">
            <button onclick="createGroup()" class="w-full btn-red text-xs py-2"><i class="fas fa-users"></i> NEW GROUP</button>
          </div>
        </div>

        <!-- CHAT AREA -->
        <div class="flex-1">
          <h2 class="text-3xl orbitron glow-red mb-6"><span id="chat-title">Select Chat</span></h2>
          <div class="card p-0 overflow-hidden h-96">
            <div id="message-list" class="h-80 overflow-y-auto p-6 space-y-4 bg-black bg-opacity-50"></div>
            <div class="p-4 border-t border-red-900 flex gap-3">
              <input type="text" id="msg-input" placeholder="Type..." class="flex-1 bg-black border border-red-900 px-5 py-3 rounded-lg text-sm" onkeypress="handleEnter(event)" />
              <button onclick="sendMessage()" class="btn-red px-8 orbitron"><i class="fas fa-paper-plane"></i></button>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

<script>
// === MATRIX RAIN (BACKGROUND) ===
const canvas = document.getElementById('matrix');
const ctx = canvas.getContext('2d');
canvas.width = innerWidth; canvas.height = innerHeight;
const drops = Array(Math.floor(canvas.width / 14)).fill(1);
setInterval(() => {
  ctx.fillStyle = 'rgba(0,0,0,0.05)'; ctx.fillRect(0,0,canvas.width,canvas.height);
  ctx.fillStyle = '#ff0033'; ctx.font = '14px monospace';
  drops.forEach((y, i) => {
    ctx.fillText(['0','1','アイ','カ','ス','ネ','ハ','ム','ラ'][Math.floor(Math.random()*9)], i*14, y*14);
    if (y*14 > canvas.height && Math.random() > 0.975) drops[i] = 0;
    drops[i]++;
  });
}, 33);

// === DB & CRYPTO ===
const DB = { get: k => JSON.parse(localStorage.getItem(k)) || null, set: (k,v) => localStorage.setItem(k, JSON.stringify(v)) };
const OWNER = { user: "John", pass: "boss123" };
let currentUser = DB.get('currentUser');
let activeChat = null;

// Generate user keypair on register/login
function getUserKeys(username) {
  let keys = DB.get('keys') || {};
  if (!keys[username]) {
    const key = crypto.randomUUID().replace(/-/g, '').slice(0, 32);
    keys[username] = { aesKey: key };
    DB.set('keys', keys);
  }
  return keys[username];
}

// E2E Encrypt/Decrypt
async function encrypt(text, recipient) {
  const senderKey = getUserKeys(currentUser.username).aesKey;
  const recipientKey = getUserKeys(recipient).aesKey;
  const shared = xorStrings(senderKey, recipientKey);
  const enc = new TextEncoder();
  const data = enc.encode(text);
  const iv = crypto.getRandomValues(new Uint8Array(12));
  const key = await crypto.subtle.importKey('raw', enc.encode(shared), 'AES-GCM', false, ['encrypt']);
  const encrypted = await crypto.subtle.encrypt({ name: 'AES-GCM', iv }, key, data);
  return btoa(String.fromCharCode(...iv, ...new Uint8Array(encrypted)));
}
async function decrypt(ciphertext, sender) {
  const senderKey = getUserKeys(sender).aesKey;
  const recipientKey = getUserKeys(currentUser.username).aesKey;
  const shared = xorStrings(senderKey, recipientKey);
  const dec = new TextDecoder();
  const data = Uint8Array.from(atob(ciphertext).split('').map(c => c.charCodeAt(0)));
  const iv = data.slice(0, 12);
  const encrypted = data.slice(12);
  const key = await crypto.subtle.importKey('raw', new TextEncoder().encode(shared), 'AES-GCM', false, ['decrypt']);
  const decrypted = await crypto.subtle.decrypt({ name: 'AES-GCM', iv }, key, encrypted);
  return dec.decode(decrypted);
}
function xorStrings(a, b) { return a.split('').map((c,i) => String.fromCharCode(c.charCodeAt(0) ^ b.charCodeAt(i%b.length))).join(''); }

// === AUTH ===
function renderAuth() {
  const el = document.getElementById('auth-section');
  if (currentUser) {
    const isOwner = currentUser.username === OWNER.user;
    el.innerHTML = `<div class="flex items-center gap-3 text-sm">
      <span class="text-red-400 font-bold">${currentUser.username}</span>
      <input id="aura-input" value="${currentUser.aura}" class="bg-black border border-red-900 px-2 py-1 rounded text-xs w-16" onblur="saveAura(this.value)" />
      ${isOwner ? '<span class="text-yellow-500">[GOD]</span>' : ''}
      <button onclick="logout()" class="text-gray-500"><i class="fas fa-sign-out-alt"></i></button>
    </div>`;
  } else {
    el.innerHTML = `<div class="flex gap-2 text-xs">
      <input id="login-user" placeholder="user" class="bg-black border border-red-900 px-3 py-1 rounded" />
      <input id="login-pass" type="password" placeholder="pass" class="bg-black border border-red-900 px-3 py-1 rounded" />
      <button onclick="login()" class="bg-red-600 px-3 py-1 rounded">LOGIN</button>
      <button onclick="register()" class="bg-gray-700 px-3 py-1 rounded">REGISTER</button>
    </div>`;
  }
  updateChats();
}
function login() {
  const u = document.getElementById('login-user').value.trim();
  const p = document.getElementById('login-pass').value;
  const users = DB.get('users') || {};
  if (users[u] && users[u].pass === p) {
    currentUser = { username: u, aura: users[u].aura || 'NEW' };
    getUserKeys(u); // init key
    DB.set('currentUser', currentUser);
    renderAuth();
  } else alert("DENIED");
}
function register() {
  const u = prompt("Username:"); const p = prompt("Password:");
  if (!u || !p) return;
  const users = DB.get('users') || {};
  if (users[u]) return alert("TAKEN");
  users[u] = { pass: p, aura: 'NEW' };
  DB.set('users', users);
  getUserKeys(u);
  alert("REGISTERED");
}
function logout() { currentUser = null; DB.set('currentUser', null); activeChat = null; renderAuth(); }
function saveAura(aura) {
  if (!currentUser) return;
  currentUser.aura = aura;
  const users = DB.get('users') || {};
  users[currentUser.username].aura = aura;
  DB.set('users', users); DB.set('currentUser', currentUser);
}

// === TABS ===
function openTab(tab) {
  document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden'));
  document.getElementById(tab).classList.remove('hidden');
  document.querySelectorAll('[id^="tab-"]').forEach(t => t.classList.remove('tab-active', 'text-red-400'));
  document.getElementById('tab-' + tab)?.classList.add('tab-active', 'text-red-400');
  if (tab === 'messages') updateChats();
}

// === CHATS: PUBLIC, DM, GROUP ===
function updateChats() {
  const list = document.getElementById('chat-list');
  const users = Object.keys(DB.get('users') || {}).filter(u => u !== currentUser?.username);
  const messages = DB.get('messages') || {};
  const groups = DB.get('groups') || {};

  let chats = [];

  // Public
  if (messages.public?.length) chats.push({ id: 'public', name: 'PUBLIC CHANNEL', type: 'public', last: messages.public.slice(-1)[0] });

  // DMs
  users.forEach(u => {
    const key = `dm_${[currentUser.username, u].sort().join('_')}`;
    if (messages[key]?.length) {
      const last = messages[key].slice(-1)[0];
      chats.push({ id: key, name: u, type: 'dm', last });
    }
  });

  // Groups
  Object.keys(groups).forEach(g => {
    if (groups[g].members.includes(currentUser.username)) {
      const key = `group_${g}`;
      if (messages[key]?.length) {
        const last = messages[key].slice(-1)[0];
        chats.push({ id: key, name: g, type: 'group', last });
      }
    }
  });

  chats.sort((a,b) => (b.last?.time || 0) - (a.last?.time || 0));

  list.innerHTML = chats.map(c => `
    <div class="p-3 cursor-pointer hover:bg-gray-800 ${activeChat===c.id ? 'dm-active' : ''}" onclick="openChat('${c.id}', '${c.name}')">
      <div class="flex justify-between">
        <span><i class="fas ${c.type==='public'?'fa-globe':c.type==='dm'?'fa-user-secret':'fa-users'}"></i> ${c.name}</span>
        <span class="text-xs text-gray-500">${new Date(c.last.time).toLocaleTimeString()}</span>
      </div>
      <div class="text-xs text-gray-400 truncate">${c.last.text}</div>
    </div>
  `).join('');

  // Auto-create DM entry if none
  if (activeChat?.startsWith('dm_') && !messages[activeChat]) {
    messages[activeChat] = [];
    DB.set('messages', messages);
  }
}

function openChat(id, name) {
  activeChat = id;
  document.getElementById('chat-title').textContent = name;
  loadMessages();
  updateChats();
}

function createGroup() {
  const name = prompt("Group Name:");
  if (!name) return;
  const groups = DB.get('groups') || {};
  if (groups[name]) return alert("EXISTS");
  groups[name] = { members: [currentUser.username], creator: currentUser.username };
  DB.set('groups', groups);
  updateChats();
}

function showFindPlayer() {
  const query = prompt("Find Player:");
  if (!query) return;
  const users = Object.keys(DB.get('users') || {});
  const found = users.find(u => u.toLowerCase().includes(query.toLowerCase()) && u !== currentUser.username);
  if (!found) return alert("NOT FOUND");
  const key = `dm_${[currentUser.username, found].sort().join('_')}`;
  openChat(key, found);
}

// === MESSAGING ===
async function sendMessage() {
  const input = document.getElementById('msg-input');
  const text = input.value.trim();
  if (!text || !activeChat) return;
  input.value = '';

  const messages = DB.get('messages') || {};
  if (!messages[activeChat]) messages[activeChat] = [];

  let msg = { text, user: currentUser.username, aura: currentUser.aura, time: Date.now() };

  // Encrypt if DM or Group
  if (activeChat.startsWith('dm_')) {
    const recipient = activeChat.split('_').find(u => u !== currentUser.username);
    msg.ciphertext = await encrypt(text, recipient);
    msg.encrypted = true;
  } else if (activeChat.startsWith('group_')) {
    const groupName = activeChat.replace('group_', '');
    const group = DB.get('groups')[groupName];
    msg.ciphertext = await encrypt(text, group.members.find(m => m !== currentUser.username) || group.members[0]);
    msg.encrypted = true;
  }

  messages[activeChat].push(msg);
  DB.set('messages', messages);
  loadMessages();
  updateChats();
}

async function loadMessages() {
  const list = document.getElementById('message-list');
  if (!activeChat) { list.innerHTML = '<p class="text-gray-500 text-center">Select a chat</p>'; return; }
  const messages = (DB.get('messages') || {})[activeChat] || [];
  list.innerHTML = await Promise.all(messages.map(async m => {
    let text = m.text;
    if (m.encrypted) {
      try { text = await decrypt(m.ciphertext, m.user); }
      catch { text = "[DECRYPT FAILED]"; }
    }
    return `<div class="flex gap-3">
      <div class="text-red-500 font-bold">${m.aura}</div>
      <div>
        <div class="text-sm"><span class="text-red-400">${m.user}</span>: ${text}</div>
        <div class="text-xs text-gray-600">${new Date(m.time).toLocaleTimeString()}</div>
      </div>
    </div>`;
  })).then(arr => arr.join(''));
  list.scrollTop = list.scrollHeight;
}

function handleEnter(e) { if (e.key === 'Enter') sendMessage(); }

// === INIT ===
renderAuth();
openTab('home');
setInterval(() => { if (activeChat) loadMessages(); updateChats(); }, 3000);
window.onresize = () => { canvas.width = innerWidth; canvas.height = innerHeight; };
</script>
</body>
</html>
