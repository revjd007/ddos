<script>
  // ==================== STATE ====================
  let currentServer = 'general';
  let users = JSON.parse(localStorage.getItem('users') || '{}');
  let messages = JSON.parse(localStorage.getItem('messages') || '{}');
  let me = JSON.parse(localStorage.getItem('me') || 'null');

  // ==================== AUTH MODALS ====================
  function showRegister() {
    document.getElementById('loginModal').classList.add('hidden');
    document.getElementById('registerModal').classList.remove('hidden');
  }

  function showLogin() {
    document.getElementById('registerModal').classList.add('hidden');
    document.getElementById('loginModal').classList.remove('hidden');
  }

  function register() {
    const email = document.getElementById('regEmail').value.trim();
    const pass = document.getElementById('regPass').value;
    if (!email || !pass) return alert('Fill all fields');
    if (users[email]) return alert('Email already exists');

    const name = email.split('@')[0];
    users[email] = {
      email, pass, name,
      avatar: `https://ui-avatars.com/api/?name=${name}&background=ff0000&color=fff&size=128`,
      bio: 'Hey, I am new here!',
      likes: 0, content: 0, messages: 0
    };
    localStorage.setItem('users', JSON.stringify(users));
    alert('Registered! Now login.');
    showLogin();
  }

  function login() {
    const email = document.getElementById('loginEmail').value.trim();
    const pass = document.getElementById('loginPass').value;
    const user = users[email];

    if (user && user.pass === pass) {
      me = user;
      localStorage.setItem('me', JSON.stringify(me));
      document.getElementById('loginModal').classList.add('hidden');
      document.getElementById('app').classList.remove('hidden');
      initApp();
    } else {
      alert('Wrong email or password');
    }
  }

  // ==================== APP INIT ====================
  function initApp() {
    document.getElementById('navAvatar').src = me.avatar;
    switchServer(document.querySelector('.server.active'));
    renderMessages();
    renderOnline();
  }

  // Auto-login if already logged in
  if (me) {
    document.getElementById('loginModal').classList.add('hidden');
    document.getElementById('app').classList.remove('hidden');
    initApp();
  }

  // ==================== SERVER SWITCH ====================
  function switchServer(serverName) {
    currentServer = serverName;
    document.getElementById('serverName').innerText =
      serverName.charAt(0).toUpperCase() + serverName.slice(1);

    document.querySelectorAll('.server').forEach(s => s.classList.remove('active'));
    document.querySelector(`.server[onclick="switchServer('${serverName}')"]`).classList.add('active');

    renderMessages();
  }

  // ==================== MESSAGES ====================
  function sendMessage() {
    const input = document.getElementById('msgInput');
    const msg = input.value.trim();
    if (!msg) return;

    if (!messages[currentServer]) messages[currentServer] = [];

    messages[currentServer].push({
      user: me.name,
      email: me.email,           // Critical: link to profile
      msg: msg,
      avatar: me.avatar,
      time: new Date().toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'})
    });

    localStorage.setItem('messages', JSON.stringify(messages));
    input.value = '';
    renderMessages();

    // Update stats
    me.messages = (me.messages || 0) + 1;
    saveMe();
  }

  function handleEnter(e) {
    if (e.key === 'Enter') sendMessage();
  }

  function renderMessages() {
    const msgs = messages[currentServer] || [];
    const container = document.getElementById('messages');
    container.innerHTML = msgs.map(m => `
      <div class="msg">
        <img src="${m.avatar}" alt="${m.user}" />
        <div class="msg-bubble">
          <div class="flex items-center gap-2">
            <strong class="cursor-pointer hover:text-red-400" 
                    onclick="viewProfile('${m.email}')">${m.user}</strong>
            <span class="text-xs opacity-50">${m.time}</span>
          </div>
          <p>${escapeHtml(m.msg)}</p>
        </div>
      </div>
    `).join('');
    container.scrollTop = container.scrollHeight;
  }

  // ==================== ONLINE USERS ====================
  function searchPlayers() {
    const query = document.getElementById('searchPlayers').value.toLowerCase();
    renderOnline(query);
  }

  function renderOnline(filter = '') {
    const list = document.getElementById('userList');
    list.innerHTML = '';

    Object.values(users)
      .filter(u => u.name.toLowerCase().includes(filter) || u.email.toLowerCase().includes(filter))
      .forEach(u => {
        const div = document.createElement('div');
        div.className = 'glass p-3 rounded-xl flex items-center gap-3 cursor-pointer';
        div.onclick = () => viewProfile(u.email);
        div.innerHTML = `
          <img src="${u.avatar}" class="w-10 h-10 rounded-full" />
          <span class="font-semibold">${u.name}</span>
          <span class="online ml-auto"></span>
        `;
        list.appendChild(div);
      });
  }

  // ==================== PROFILE MODAL ====================
  function viewProfile(email) {
    const u = users[email];
    if (!u) return;

    document.getElementById('profileNameModal').innerText = u.name;
    document.getElementById('profileBioModal').innerText = u.bio || 'No bio yet';
    document.getElementById('profileAvatar').src = u.avatar;
    document.getElementById('profileLikes').innerText = u.likes || 0;
    document.getElementById('profileContent').innerText = u.content || 0;
    document.getElementById('profileMessages').innerText = u.messages || 0;

    document.getElementById('profileModal').classList.remove('hidden');
  }

  function closeProfile() {
    document.getElementById('profileModal').classList.add('hidden');
  }

  function showProfile() {
    viewProfile(me.email);
  }

  function startDM() {
    alert(`DM with ${document.getElementById('profileNameModal').innerText} started!`);
    closeProfile();
  }

  // ==================== UPLOAD ====================
  function showUpload() {
    document.getElementById('uploadModal').classList.remove('hidden');
  }

  function uploadContent() {
    const title = document.getElementById('uploadTitle').value.trim();
    const file = document.getElementById('uploadFile').files[0];
    if (!title || !file) return alert('Title and file required');

    me.content = (me.content || 0) + 1;
    saveMe();
    alert(`"${title}" uploaded!`);
    document.getElementById('uploadModal').classList.add('hidden');
    document.getElementById('uploadTitle').value = '';
    document.getElementById('uploadFile').value = '';
  }

  // ==================== THEME ====================
  function toggleDark() {
    document.body.classList.toggle('dark');
  }

  // ==================== UTILS ====================
  function saveMe() {
    localStorage.setItem('me', JSON.stringify(me));
    users[me.email] = me;
    localStorage.setItem('users', JSON.stringify(users));
  }

  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }
</script>
